
  {% extends "base_top_only.html" %}
   {% block content %}
    
    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/terminal/terminal.js"></script>
    <script>

// Terminal
    var util = util || {};
util.toArray = function (list) {
    return Array.prototype.slice.call(list || [], 0);
};

var Terminal = Terminal || function (cmdLineContainer, outputContainer) {
    window.URL = window.URL || window.webkitURL;
    window.requestFileSystem = window.requestFileSystem || window.webkitRequestFileSystem;

    var cmdLine_ = document.querySelector(cmdLineContainer);
    var output_ = document.querySelector(outputContainer);

    const CMDS_ = [
        'activities', 'exported_activities', 'services', 'receivers', 'providers', 'libraries',
        'clear', 'date', 'echo', 'help', 'shell', 'pull', 'push',
        'devices', 'forward', 'start-server', 'kill-server', 'wait-for-device',
        'connect', 'reconnect', 'disconnect', 'usb', 'install', 'uninstall',
        'logcat', 'root', 'sideload', 'tcpip', 'unroot',
        'reboot', 'remount', 'get-devpath', 'get-serialno', 'get-state',
        'keygen', 'enable-verity', 'disable-verity', 'jdwp', 'bugreport',
        'backup', 'restore', 'install-multi-package', 'install-multiple',
        'sync', 'reverse', 'ppp', 'version',

    ];

    var history_ = [];
    var histpos_ = 0;
    var histtemp_ = 0;
    var intro = '<h3 style="letter-spacing: 2px">Shell Access</h3><p>' + new Date() + '</p><p>Enter "help" for more information.</p>';

    window.addEventListener('click', function (e) {
        cmdLine_.focus();
    }, false);

    cmdLine_.addEventListener('click', inputTextClick_, false);
    cmdLine_.addEventListener('keydown', historyHandler_, false);
    cmdLine_.addEventListener('keydown', processNewCommand_, false);

    function inputTextClick_(e) {
        this.value = this.value;
    }

    function historyHandler_(e) {
        if (history_.length) {
            if (e.keyCode == 38 || e.keyCode == 40) {
                if (history_[histpos_]) {
                    history_[histpos_] = this.value;
                } else {
                    histtemp_ = this.value;
                }
            }

            if (e.keyCode == 38) { // up
                histpos_--;
                if (histpos_ < 0) {
                    histpos_ = 0;
                }
            } else if (e.keyCode == 40) { // down
                histpos_++;
                if (histpos_ > history_.length) {
                    histpos_ = history_.length;
                }
            }

            if (e.keyCode == 38 || e.keyCode == 40) {
                this.value = history_[histpos_] ? history_[histpos_] : histtemp_;
                this.value = this.value; // Sets cursor to end of input.
            }
        }
    }

    function escape(data) {
        var encodedStr = data.replace(/[\u00A0-\u9999<>\&]/gim, function (i) {
            return '&#' + i.charCodeAt(0) + ';';
        });
        return encodedStr;
    }

    function output(html, escape_=false, pre=false) {
        if (escape_)
            html = escape(html);
        if (pre)
         output_.insertAdjacentHTML('beforeEnd', '<pre class="clean-text">' + html + '</pre>');
        else
         output_.insertAdjacentHTML('beforeEnd', '<p>' + html + '</p>');
    }

    // Cross-browser impl to get document's height.
    function getDocHeight_() {
        var d = document;
        return Math.max(
            Math.max(d.body.scrollHeight, d.documentElement.scrollHeight),
            Math.max(d.body.offsetHeight, d.documentElement.offsetHeight),
            Math.max(d.body.clientHeight, d.documentElement.clientHeight)
        );
    }
    function get_comp(comp){
      $.ajax({
            url : "../get_component/", 
            type : "POST",
            dataType: "json", 
            data : {
                csrfmiddlewaretoken: '{{ csrf_token }}',
                component: comp,
                hash: '{{ md5 }}',
                },
                success : function(json) {
                    if (json.status==="ok"){
                      output(json.resp, true, true);
                    }
                },
                error : function(xhr,errmsg,err) {
                    document.getElementById("er").srcdoc = xhr.responseText;
                }   
    });
    }
    function processNewCommand_(e) {

        if (e.keyCode == 9) { // tab
            e.preventDefault();
            // Implement tab suggest.
        } else if (e.keyCode == 13) { // enter
            // Save shell history.
            if (this.value) {
                history_[history_.length] = this.value;
                histpos_ = history_.length;
            }

            // Duplicate current input and append to output section.
            var line = this.parentNode.parentNode.cloneNode(true);
            line.removeAttribute('id')
            line.classList.add('line');
            var input = line.querySelector('input.cmdline');
            input.autofocus = false;
            input.readOnly = true;
            output_.appendChild(line);

            if (this.value && this.value.trim()) {
                var args = this.value.split(' ').filter(function (val, i) {
                    return val;
                });
                var cmd = args[0].toLowerCase();
                var exec_cmd = args.join(' ');
                args = args.splice(1); // Remove cmd from arg list.
            }

            switch (cmd) {
                case 'clear':
                    output_.innerHTML = '';
                    this.value = '';
                    output(intro);
                    return;
                case 'date':
                    output(new Date());
                    break;
                case 'echo':
                    output(exec_cmd, true);
                    break;
                case 'activities':
                    get_comp('activities')
                    break;
                case 'exported_activities':
                    get_comp('exported_activities')
                    break;
                case 'services':
                    get_comp('services')
                    break;
                case 'receivers':
                    get_comp('receivers')
                    break;
                case 'providers':
                    get_comp('providers')
                    break;
                case 'libraries':
                    get_comp('libraries')
                    break;
                case 'help':
                    output('<div class="ls-files">' + CMDS_.join('<br>') + '</div>');
                    break;
                default:
                    if (cmd) {
                        $.ajax({
                                url : "../execute_adb/", 
                                type : "POST",
                                dataType: "json", 
                                data : {
                                    csrfmiddlewaretoken: '{{ csrf_token }}',
                                    cmd: DOMXSSSafeJS(exec_cmd),
                                    },
                                    success : function(json) {
                                        if (json.cmd==="yes"){
                                          output(json.resp, true, true);
                                        }
                                    },
                                    error : function(xhr,errmsg,err) {
                                        document.getElementById("er").srcdoc = xhr.responseText;
                                    }   
                        });
                    }
            };
            window.scrollTo(0, getDocHeight_());
            this.value = ''; // Clear/setup line for next input.
        }
    }

   
  
    return {
        init: function () {
            output(intro);
        },
        output: output
    }
};
</script>
    <link rel='stylesheet' href='/static/terminal/terminal.css' type='text/css'>
    <link rel='stylesheet' href='/static/css/devices.min.css' type='text/css'>

   <style>
      textarea {
        width: 100%;
        height: 650px;
        -moz-border-bottom-colors: none;
        -moz-border-left-colors: none;
        -moz-border-right-colors: none;
        -moz-border-top-colors: none;
        background: none repeat scroll 0 0 rgba(0, 0, 0, 0.07);
        border-color: -moz-use-text-color #FFFFFF #FFFFFF -moz-use-text-color;
        border-image: none;
        border-radius: 6px 6px 6px 6px;
        border-style: none solid solid none;
        border-width: medium 1px 1px medium;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.12) inset;
        color: #555555;
        font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
        font-size: 1em;
        line-height: 1.4em;
        padding: 5px 8px;
        transition: background-color 0.2s ease 0s;
    }
    textarea:focus {
        background: none repeat scroll 0 0 #FFFFFF;
        outline-width: 0;
    }
</style>
<script>
//Screen Stream
function imgloading(){
    $('#my').attr('src','/static/img/loading.jpg');
}
</script>


<br/>
<h2 class="page-header"><strong>Dynamic Analyzer </strong>- {{ package }}</h2>
<input type="hidden" id="screen_width" value="{{ screen_witdth }}">
<input type="hidden" id="screen_height" value="{{ screen_height }}">
<div class="row">
    <p id="but">
      <a id="screen" class="btn btn-primary" role="button" style="visibility: hidden" >Show Screen</a>
      <a id="rootca" class="btn btn-primary" role="button" style="visibility: hidden" >Remove MobSF RootCA</a>
      <a id="expactt" class="btn btn-primary" role="button" style="visibility: hidden" >Start Exported Activity Tester</a>
      <a id="actt" class="btn btn-primary" role="button" style="visibility: hidden" >Start Activity Tester</a>
      <a id="ss" class="btn btn-primary" role="button" style="visibility: hidden" >Take a Screenshot</a>
      <a id="stop" class="btn btn-primary" role="button" style="visibility: hidden" >Finish</a>

    </p>
  </div>

      <div class="row">
        <div class="col-md-5">
          <!-- Custom Tabs -->
        
        <div class='marvel-device htc-one'>
        <div class='top-bar'></div>
        <div class='camera'></div>
        <div class='sensor'></div>
        <div class='speaker'></div>
        <div class='screen' id='container'>
        <img width='320' height='580' src='../download/screen/screen.png' id='my' onerror='imgloading()' style='background-color:black;'>
        </div>
        </div>
          <!-- nav-tabs-custom -->
        </div>
        <!-- /.col -->

        <div class="col-md-7">
          <!-- Custom Tabs (Pulled to the right) -->
      <div class="nav-tabs-custom">
            <ul class="nav nav-tabs">
              <li class="active"><a href="#tab_1" data-toggle="tab">VM Status</a></li>
              <li><a href="#tab_2" data-toggle="tab">Errors</a></li>
            </ul>
            <div class="tab-content">
              <div class="tab-pane active" id="tab_1">
              <textarea id="stat"></textarea>
              </div>
              <!-- /.tab-pane -->
              <div class="tab-pane" id="tab_2"> 
              <iframe sandbox frameborder="0" width="100%" height="650px" id="er"></iframe>
              </div>
            </div>
            <!-- /.tab-content -->
          </div>
          <!-- nav-tabs-custom -->
        </div>
        <!-- /.col -->
      </div>
      <!-- /.row -->

  <br/>
  <br/>
              
    <div id="shell">
      <output></output>
      <div id="input-line" class="input-line">
        <div class="prompt"></div><div><input class="cmdline" autofocus /></div>
      </div>
    </div>
    
<script>
$(document).ready(function() {
//Terminal
$(function() {
    $('.prompt').html('[root@android_x86] # ');
    var term = new Terminal('#input-line .cmdline', '#shell output');
    term.init();
});

// Start up
$('#stat').append("\nSetting up Dynamic Analysis environment");
$('#stat').append("\nRunning HTTPS intercepting proxy");
$('#stat').append("\nClipboard Monitoring Started!");
$('#stat').append("\nEnvironment is Ready!");
$('#stat').append("\nAgents are running in the Background");
$('#stat').append("\nGo Ahead and navigate through all the flows of the Application.");
$('#screen').css("visibility","visible");
//show screenshot
$('#ss').css("visibility","visible");
//show finish
$('#stop').css("visibility","visible");
//show exported activity tester
$('#expactt').css("visibility","visible");
//show activity tester
$('#actt').css("visibility","visible");
//show mobsf rootca installer
$('#rootca').css("visibility","visible");


// Touch Events
var touch = "off";
var refresh = false;
$('#my').click(function(e) {

  if (touch === "on")
  {
    var res=[$('#screen_width').val(),$('#screen_height').val()];
    var width = res[0];
    var height =res[1];
    if (width.length > 0 && height.length > 0)
    {
      width = parseInt(width);
      height = parseInt(height);
      var offset = $(this).offset();
      var x = e.pageX - offset.left;
      var y = e.pageY - offset.top;
      x = x * (width/320); 
      y = y * (height/580);
      console.log('X Axis: '+ x + " Y Axis: "+ y);
      $.ajax({
                url : '../touch_events/', 
                type : 'POST',
                dataType: 'json', 
                data : {
                        csrfmiddlewaretoken: '{{ csrf_token }}',
                        x: x,
                        y: y,
                        },
                    success : function(json) {
                        if (json.status==='success'){
                        console.log('Clicked!');
                        }
                    },
                    error : function(xhr,errmsg,err) {
                        document.getElementById("er").srcdoc = xhr.responseText;
                    }   
      });
      }
  }
});

//Screen
var screenfunc;
$("#screen").click(function() {

      var stext = $("#screen").text();
      var md;
      if (stext === "Show Screen")
      {
        $("#screen").text("Stop Screen");
        $('#stat').append("\nScreen streaming started");
        touch = "on";
            screenfunc = setInterval(function(){
              // Capture Screen
              $.ajax({
                url : "../screen_cast/", 
                type : "POST",
                dataType: "json", 
                data : {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    },
                    success : function(json) {
                        //Load Screen
                      $('#my').attr('src', '../download/screen/screen.png?'+new Date().getTime());
                    },
                    error : function(xhr,errmsg,err) {
                        document.getElementById("er").srcdoc = xhr.responseText;
                    }   
                });

            },3000);
      }
      else
      {
        $("#screen").text("Show Screen");
        $('#stat').append("\nScreen streaming stopped");
        $('#my').attr('src', '/static/img/loading.jpg');
        clearInterval(screenfunc);
        touch = "off";
      }
        $('#stat').scrollTop($('#stat')[0].scrollHeight);
      return false;  
}); 

//Screenshot
 			$("#ss").click(function() {
                    	$('#stat').append("\nTaking a Scrennshot....");
                    		$.ajax({
                                url : "../TakeScreenShot/", 
                                type : "POST",
                                dataType: "json", 
                                data : {
                                    csrfmiddlewaretoken: '{{ csrf_token }}',
                                    md5: '{{ md5 }}',
                                    },
                                    success : function(json) {
                                    	if (json.screenshot==="yes"){
                                    	$('#stat').append("\nScreenshot Taken!");
                                    	$('#stat').scrollTop($('#stat')[0].scrollHeight);
										}
                                    },
                                    error : function(xhr,errmsg,err) {
                                        document.getElementById("er").srcdoc = xhr.responseText;
                                    }   
                      });
                    return false;  
                }); 

    //MobSF CA

      $("#rootca").click(function() {
                  
                       var stext = $("#rootca").text();
                       var act;
                       if (stext === "Remove MobSF RootCA")
                       {
                        $("#rootca").text("Install MobSF RootCA");
                        act = "remove";
                       }
                       else
                       {
                        $("#rootca").text("Remove MobSF RootCA");
                        act = "install";
                       }

                        $.ajax({
                                url : "../MobSFCA/", 
                                type : "POST",
                                dataType: "json", 
                                data : {
                                    action: act,
                                    csrfmiddlewaretoken: '{{ csrf_token }}',
                                    },
                                    success : function(json) {
                                      if (json.ca==="installed"){
                                      $('#stat').append("\nMobSF RootCA Installed Successfully");
                                    }
                                    else if (json.ca==="removed"){
                                      $('#stat').append("\nMobSF RootCA Removed Successfully");
                                    }
                                    $('#stat').scrollTop($('#stat')[0].scrollHeight);
                                    },
                                    error : function(xhr,errmsg,err) {
                                        document.getElementById("er").srcdoc = xhr.responseText;
                                    }   
                      });
                    return false;  
                }); 

       //Start ExportedActivity Tester
     $("#expactt").click(function()  {
                        $('#stat').append("\nStarting Exported Activity Tester...");
                        $.ajax({
                                url : "../ExportedActivityTester/", 
                                type : "POST",
                                dataType: "json", 
                                data : {
                                    csrfmiddlewaretoken: '{{ csrf_token }}',
                                    md5: '{{ md5 }}',
                                    pkg: '{{ package }}',
                                    },
                                    success : function(json) {
                                      if (json.expacttest==="done"){
                                  $('#stat').append("\nExported Activity Testing Completed.");
                                  $('#stat').scrollTop($('#stat')[0].scrollHeight);
                                    }
                                    else if(json.expacttest=="noact"){
                                      $('#stat').append("\nNo Activities Found!");
                                  $('#stat').scrollTop($('#stat')[0].scrollHeight);
                                    }

                                    },
                                    error : function(xhr,errmsg,err) {
                                       document.getElementById("er").srcdoc = xhr.responseText;
                                    }   
                      });
                    return false;  
                }); 


      //Start Activity Tester
     $("#actt").click(function()  {
                        $('#stat').append("\nStarting Activity Tester...");
                        $.ajax({
                                url : "../ActivityTester/", 
                                type : "POST",
                                dataType: "json", 
                                data : {
                                    csrfmiddlewaretoken: '{{ csrf_token }}',
                                    md5: '{{ md5 }}',
                                    pkg: '{{ package }}',
                                    },
                                    success : function(json) {
                                      if (json.acttest==="done"){
                                  $('#stat').append("\nActivity Testing Completed.");
                                  $('#stat').scrollTop($('#stat')[0].scrollHeight);
                                    }
                                    else if(json.acttest=="noact"){
                                      $('#stat').append("\nNo Activities Found!");
                                  $('#stat').scrollTop($('#stat')[0].scrollHeight);
                                    }

                                    },
                                    error : function(xhr,errmsg,err) {
                                       document.getElementById("er").srcdoc = xhr.responseText;
                                    }   
                      });
                    return false;  
                }); 

//Finish Testing
     $("#stop").one( "click", function() {
                    	$('#stat').append("\nCollecting Data...");

                      //Stop Screen Casting if it's running
			
                       var stext = $("#screen").text();
                       var md;
                       if (stext === "Stop Screen")
                       {
                        $("#screen").text("Show Screen");
                        md = "off";
                        $.ajax({
                          url : "../ScreenCast/", 
                          type : "POST",
                          dataType: "json", 
                          data : {
                              mode: md,
                              csrfmiddlewaretoken: '{{ csrf_token }}',
                              },
                              success : function(json) {
                                
                                if (json.status==="off"){
                                touch = "off;"
                                refresh = false;
                                $('#stat').append("\nScreen sharing stopped");
                                $('#my').attr('src', '/static/img/loading.jpg');

                              }
                                $('#stat').scrollTop($('#stat')[0].scrollHeight);
                                
                              },
                              error : function(xhr,errmsg,err) {
                                  document.getElementById("er").srcdoc = xhr.responseText;
                              }   
                        });
                      }
                        //
                    		$.ajax({
                                url : "../FinalTest/", 
                                type : "POST",
                                dataType: "json", 
                                data : {
                                    csrfmiddlewaretoken: '{{ csrf_token }}',
                                    md5: '{{ md5 }}',
                                    pkg: '{{ package }}',
                                    },
                                    success : function(json) {
                                    	if (json.final==="yes"){
                                    	$('#stop').addClass("btn btn-success");
                                    	$('#stop').text("Testing Completed");
                                    	$('#stat').append("\nDownloading Logcat logs");
                             			$('#stat').append("\nDownloading Droidmon API Monitor Logcat logs");
                             			$('#stat').append("\nDownloading Dumpsys logs");
                             			$('#stat').append("\nStopping Application");
                                    	$('#stat').scrollTop($('#stat')[0].scrollHeight);
                                    	dump();
                                    }

                                    },
                                    error : function(xhr,errmsg,err) {
                                       document.getElementById("er").srcdoc = xhr.responseText;
                                    }   
                      });
                    return false;  
                }); 

                //end doc.ready
			});
function DOMXSSSafeJS(data)
{
  return data
      .replace(/</g, "\u003c")
      .replace(/>/g, "\u003e")
      .replace(/"/g, "\u0022")
      .replace(/'/g, "\u0027")
      .replace(/`/g, "\u0060")
      .replace(/\(/g, "\u0028")
      .replace(/\)/g, "\u0029")
      .replace(/{/g, "\u007b")
      .replace(/}/g, "\u007d")
      .replace(/-/g, "\u002d")
      .replace(/\+/g, "\u002b")
      .replace(/\//g, "\u002f")
      .replace(/\$/g, "\u0024");

}
function DOMXSSSafeHTML(data)
{
  return data
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#x27;")
      .replace(/`/g, "&#x60;")
      .replace(/\(/g, "&#x28;")
      .replace(/\)/g, "&#x29;")
      .replace(/{/g, "&#x7B;")
      .replace(/}/g, "&#x7D;")
      .replace(/-/g, "&#x2D;")
      .replace(/\+/g, "&#x2B;");
}
		function dump()
		{
			$('#stat').append("\nDumping Application Data from the device. Please Wait....");
			$('#stat').scrollTop($('#stat')[0].scrollHeight);
                    		$.ajax({
                                url : "../DumpData/", 
                                type : "POST",
                                dataType: "json", 
                                data : {
                                    csrfmiddlewaretoken: '{{ csrf_token }}',
                                    md5: '{{ md5 }}',
                                    pkg: '{{ package }}',
                                    },
                                    success : function(json) {
                                    	if (json.dump==="yes"){
                                    	$('#stat').append("\nApplication Data Dumped!");
                             			$('#stat').append("\nGenerating Report...Please Wait!");
                                    	$('#stat').scrollTop($('#stat')[0].scrollHeight);
                                    	//Call reporting
                                      location.href="//"+location.host+"/Report/?md5={{ md5 }}&pkg={{ package }}";
                                    }

                                    },
                                    error : function(xhr,errmsg,err) {
                                       document.getElementById("er").srcdoc = xhr.responseText;
                                    }   
                      });
               

		}
      </script>
  
		
   {% endblock %}
